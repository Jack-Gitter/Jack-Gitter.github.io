<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSO via SAML</title>
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="./saml.css">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js?skin=desert"></script>
</head>
<body>
    <header>
        <h1>SSO via SAML</h1>
            <p class="date">November 23, 2025</p>
    </header>
    <main>
        <article>
            <a href="https://jack-gitter.github.io" class="top-right-button">üè†</a>
			<h2>What is SSO</h2>
				Single sign on, otherwise known as SSO, is a technique that allows an end user to sign in once, and access an entire suite of applications without having to authenticate into each individual service. Before understanding the intricacies of SSO, there are a couple of useful terms to understand

                <dl class="light-gray">
                  <dt>Identity Provider</dt>
                  <dd>The identity provider is the "service" that handles authentication for end users. It keeps track of user logins, and verifies that users are who they say they are. Common examples of an IDP are Okta, and Auth0</dd>

                  <dt>Service Provider</dt>
                  <dd>
					  The Service Provider, or SP, is the service that the end user actually wants to gain access to after authenticating. Depending on the end user, they might have access to a variety of different services, such as gitlab, or a CRM. After authenticating via an IDP, the users are able to access the SP without requiring another round of authentcation
				  </dd>
                </dl>

			<h2>IDP Initiated SSO</h2>
			<p>
			IDP initiated SSO is one of the two possible SSO flows involved with SAML, which is something we will discuss later. IDP initiated SSO involves first signing into an identity provider, like okta, and then being able to click into individual service providers. 


            <div class="image-description-block">
			<img src="./okta-experience.png" style="width:100%">
                <p>
				Example login screen after authenticating via Okta
                </p>
            </div>

			As you can see, all of the available clickable boxes represents a service provider that the user has access to
			</p>
			<h3>Very high-level example</h3>
				IDP initiated SSO flow goes like this

				<ol>
					<li>
						User navigates to their IDP, for example www.okta.com
						<div class="image-description-block">
							<img src="./okta login.png">
							<p>
							Okta login screen
							</p>
						</div>
					</li>
					<li>
						User enters authentication information and signs-in, and the IDP creates a session for the user
					</li>
					<li>
						The IDP gathers information on the logged-in user, and 
						creates a bundle of information to send to the service provider
					</li>
					<li>
						When the user clicks the cards for a service provider, the user information 
						is sent to the service provider. The service providers validate the information is 
						from Okta, and then create a user session and allow the user in based on the information
						that okta has provided in the SAML Response
					</li>
				</ol>

			<h2>SP Initiated SSO</h2>
				The other flow option for SSO is SP-initiated SSO. This flow goes like so

				<h3>Very high-level example</h3>
				<ol>
					<li>
						User navigates to their SP of choice, for example www.linkedin.com
					</li>
					<li>
						the service provider sends an authentication request to the IDP with information about who the service provider is, what time the request occured, etc.
					</li>
					<li>
						The IDP will parse this response, and then redirect the user to their login screen
						<div class="image-description-block">
							<img src="./okta login.png">
							<p>
							Okta login screen
							</p>
						</div>
					</li>
					<li>
						The user signs in with their IDP, and the IDP once again creates the bundle of user information
					</li>
					<li>
						This time, the user is automatically redirected to the service provider,  
					</li>
					<li>
						The service provider verifies in the information is from the IDP, and then cretes the user session
					</li>
				</ol>

			<h2>What is XML</h2>
			XML, also known as extensible markup language, 
			is the format in which messages are sent between the IDP and the SP. It is important for them to establish a "language" to 
			communicate with, so that they can parse and understand messages easily
			<h2>What is SAML</h2>
			SAML is a security assertion markup language, which utilizes XML. It is an open standard, essentially a defined schema in which to write XML that both the service providers and identity providers expect. 
			<h3>SAML Request</h3>
			The SAML request is what is sent from the sp to the idp during service provider initiated SSO. The service provider essentially is requesting the user be authenticated via the IDP.
			An example of a SAML request looks like so:

			<pre class="prettyprint lang-xml" id="xml-block">
&lt;samlp:AuthnRequest xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;
				xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;
				ForceAuthn=&quot;false&quot;
				ID=&quot;ac3757ab77f8f87c695cbc073c3720b4e4348e518&quot;
				IssueInstant=&quot;2025-11-23T13:31:51Z&quot;
				Destination=&quot;http://localhost:3000/saml/auth&quot;
				AssertionConsumerServiceURL=&quot;https://sptest.iamshowcase.com/acs&quot;
				ProtocolBinding=&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;
				Version=&quot;2.0&quot;&gt;
&lt;saml:Issuer&gt;IAMShowcase&lt;/saml:Issuer&gt;
&lt;/samlp:AuthnRequest&gt;
			</pre>

				Here is a description of the purpose of the fields, and some key attributes

				<br>
					<dl class="light-gray">
					  <dt>AuthnRequest</dt>
					  <dd>The authnRequest, or authentication request, is the wrapped for the request from the service provider to the identity provider. It has a a couple of key attributes
					  <ul>
						<li style="margin-left: 20px">
							ID: <span>the specific AuthnRequest ID. Unique for each request. This is used in the SAML Response to indicate which request the response is tied to</span>
						</li >
						<li style="margin-left: 20px">
							Issue Instant: <span>The time when the request was created</span>
						</li>
						<li style="margin-left: 20px">
							Destination: <span>Where the request is being sent to</span>
						</li>
						<l style="margin-left: 20px">
							Assertion Consumer Service URL: <span>Where the IDP should send the SAML response to</span>
						</li>
						<li style="margin-left: 20px">
							Protocol Binding: <span>The method which the IDP should send the SAML resposne via</span>
						</li>
					  </ul>
					  </dd>
					  <dt>Issuer</dt>
					  <dd>the issuer field is who issues the AuthnRequest</dd>
					</dl>

				there are more fields, all of which can be found here described in greater detail: https://learn.microsoft.com/en-us/entra/identity-platform/single-sign-on-saml-protocol#authnrequest. 

			<h3>SAML Response</h3>
			The SAML response is used in both the IDP initiated and sp initiated sso flows. This is the bundle of user information that is sent from the idp to the service provider, to explain that the user has authenticated properly and apss any relevaant user information to the SP. 
			<pre class="prettyprint lang-xml" id="xml-block">
&lt;samlp:Response
    xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;
    xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;
    ID=&quot;_0e266799-35e6-4131-85b3-d049d6097536&quot;
    Version=&quot;2.0&quot;
    IssueInstant=&quot;2025-11-22T19:06:04.594Z&quot;
    Destination=&quot;https://sptest.iamshowcase.com/acs&quot;
    InResponseTo=&quot;&quot;&gt;
  &lt;saml:Issuer&gt;https://test-saml.com&lt;/saml:Issuer&gt;
  &lt;samlp:Status&gt;
    &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot; /&gt;
  &lt;/samlp:Status&gt;
  &lt;saml:Assertion
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot;
      xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;
      ID=&quot;_8dea871c-d9a2-4928-8219-2bad6cc9a9b0&quot;
      Version=&quot;2.0&quot;
      IssueInstant=&quot;2025-11-22T19:06:04.594Z&quot;&gt;
    &lt;saml:Issuer&gt;https://test-saml.com&lt;/saml:Issuer&gt;
    &lt;ds:Signature
        xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;
      &lt;ds:SignedInfo&gt;
        &lt;ds:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; /&gt;
        &lt;ds:SignatureMethod Algorithm=&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot; /&gt;
        &lt;ds:Reference URI=&quot;#_8dea871c-d9a2-4928-8219-2bad6cc9a9b0&quot;&gt;
          &lt;ds:Transforms&gt;
            &lt;ds:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot; /&gt;
            &lt;ds:Transform Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; /&gt;
          &lt;/ds:Transforms&gt;
          &lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot; /&gt;
          &lt;ds:DigestValue&gt;q8x9brh1e7pMcTKLPMGa5RyGPgyy7EGiFD4eEwoRI0Q=&lt;/ds:DigestValue&gt;
        &lt;/ds:Reference&gt;
      &lt;/ds:SignedInfo&gt;
      &lt;ds:SignatureValue&gt;WQW3+5vmnaOXPPPD5gz1gw0I8CU1tv0jRjHhG1l2oxPmyUgRBa8dGZjderuPg70oaMcakUgLN/dOfwKE6BKMnanw42PqyZO/kIHtwepniiXMJQ+BT4Lc1MX1TLOzpqomFtoD//0jRKW0R0uvF5yOOEKMwDoh9Zkjq0WQfUlxlwrt6oTlIfNJruEtiH0pApfp2EqJ4XrKjEr39NQh2UDJfJwQOx1NMNRnyI6IjfzRYJHY/14lMjUWfe1mG3NDU1LhsUYfe4Myzg0T5ahiYmZqjCXYMEsaUJJvKlC17M23ovSa+YVP8zl0WUvMD+fpy3lewfayj6ZUl6JkuVUYQ+0MsQ==&lt;/ds:SignatureValue&gt;
      &lt;ds:KeyInfo&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;MIIDQTCCAimgAwIBAgIUdYK4XoQpN1hFs9yHDGAU/M2cCEgwDQYJKoZIhvcNAQELBQAwSTELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJTRjEMMAoGA1UECgwDT3JnMRIwEAYDVQQDDAlsb2NhbGhvc3QwHhcNMjUxMTIyMTY0NDQyWhcNMjYxMTIyMTY0NDQyWjBJMQswCQYDVQQGEwJVUzELMAkGA1UECAwCQ0ExCzAJBgNVBAcMAlNGMQwwCgYDVQQKDANPcmcxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKc+bRQeN+KXlE3IB5U+VJ0rU7Wv+EC9L44IbgODEWPqq6aJ0lPUwLrM7embvqFHKP/0lwbINyrwnOkVtwpmG0D43qtOACcmM6XUU9cB8j1TjEMgddVURI+TaMvWIKfV2rOzcB6x4oEOQ5cKVFMLJtTCcZwd8TKGnAbVw0jbV3cK7HW9bLtyQApZB2s41f1fyDvnOmrOShuDfLvnHaHjXD55Gjd4RpddxAMqKaL5bUIR2KPJkgb7As07ELIQmai6in0Aco5jV5HJsrJinMdIT6BOisP4DM3LjO7v5UsO8ZLqpQzg03l6fOIsiOdluAokq8N48nh/Ms2wBSs04+BKY68CAwEAAaMhMB8wHQYDVR0OBBYEFBT0hqLfFDC/87ywfCPKuw9M1xylMA0GCSqGSIb3DQEBCwUAA4IBAQA2uDbyXTqaVYrDdb0jcAmEQEMMP2YWCJhPSkgn9URqdlByG6UtVsA+ZbDUFgaQpPK9oM5yLJFeyQGhFs9hoodoqT3mhp3q/mXfEk95e7uPUV+v9HdBO1jB1PUX1j104QVmhbEGQqBMDsIPclEcXmUn3EOXSNZhQGXV/D8GRAjHvpO0bl/s9CFxvwBwupKXT5e4c61scjD17dmeVMTTfh653JGZAyR32oTFkzrZcDAO9soBUxo6dsK/mHiir5i/viVI3uS5izNHgp4aHN4awnEWm9hAMxaX16MYcXFyv4n2Prc2EM+DaNbD5Jh5GMo+VDmK8fkqaBsro+SO/o1/eFgA&lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
    &lt;/ds:Signature&gt;
    &lt;saml:Subject&gt;
      &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;&gt;jack.gitter@gmail.com&lt;/saml:NameID&gt;
      &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;
        &lt;saml:SubjectConfirmationData NotOnOrAfter=&quot;2025-11-22T19:11:04.594Z&quot;
                                      Recipient=&quot;https://sptest.iamshowcase.com/acs&quot;
                                      InResponseTo=&quot;&quot; /&gt;
      &lt;/saml:SubjectConfirmation&gt;
    &lt;/saml:Subject&gt;
    &lt;saml:Conditions NotBefore=&quot;2025-11-22T19:06:04.594Z&quot;
                     NotOnOrAfter=&quot;2025-11-22T19:11:04.594Z&quot;&gt;
      &lt;saml:AudienceRestriction&gt;
        &lt;saml:Audience&gt;IAMShowcase&lt;/saml:Audience&gt;
      &lt;/saml:AudienceRestriction&gt;
    &lt;/saml:Conditions&gt;
  &lt;/saml:Assertion&gt;
&lt;/samlp:Response&gt;
			</pre>
	There are many more fields to a SAML Resonse than to a SAML request. Below is described some of the most important, and required fields 
                <dl class='light-gray'>
                  <dt>Response</dt>
                  <dd>The outer wrapper of the information sent from IDP to SP. It has a couple of important attributes
					  <ul>
						  <li style="margin-left: 20px">ID : <span>unique id for this response<span></li>
						  <li style="margin-left: 20px">Issue Insant : <span>instant this was issued</span></li>
						  <li style="margin-left: 20px">Destination : <span>the ACS endpoint, found in the request</span></li>
						  <li style="margin-left: 20px">In Response To : <span>The ID of the request. Here it is blank, as this was an IDP initiated SSO payload</span></li>
					  </ul>
				  </dd>
                  <dt>Issuer</dt>
                  <dd>The IDP's entity name or id</dd>
                  <dt>Status</dt>
                  <dd>conveys whether the sign-in was successful or not</dd>
                  <dt>Assertion</dt>
					<dd>The main element encopassing most of the user and auth information. The following are the most important inclusions that reside within the assertion</dd>
							<dt style="margin-left: 20px">Issuer</dt>
							<dd style="margin-left: 40px">The IDP's entity name or id</dd>
							<dt style="margin-left: 20px">Signature</dt>
							<dd style="margin-left: 40px">Digital signature of the assertion contents</dd>
							<dt style="margin-left: 20px">Subject</dt>
							<dd style="margin-left: 40px">Defines who the SAML assertion is about. Contains a NameID field which represents the authenticated user. There are multiple different formats for NameID, and they can be persistent or transient. It all depends on how the SP intents to use the nameID</dd>
							<dt style="margin-left: 20px">Conditions</dt>
							<dd style="margin-left: 40px">Typically defines a NotBefore and NotOnOrAfter fields, determining what time period the assertion is valid for</dd>
							<dt style="margin-left: 20px">Audience</dt>
							<dd style="margin-left: 40px">Contains the URI that identifies the intended recipient of the SAML Response</dd>
							<dt style="margin-left: 20px">Atribute Statement</dt>
							<dd style="margin-left: 40px">Contains claims about the user, typically additional information that the IDP would store such as email, name, etc</dd>
							<dt style="margin-left: 20px">AuthnStatement</dt>
							<dd style="margin-left: 40px">Describes what method the user authenticated with, such as a password. Also provides timestamp information similar to conditions</dd>
                </dl>


				To find out more, visit Microsoft's <a href='https://learn.microsoft.com/en-us/entra/identity-platform/single-sign-on-saml-protocol#response'>documentation</a>
				
			<h2>Bindings</h2>
			In order to send the SAML Request and SAML Response between SP and IDP, there needs to be some conventions and protocols used. The protocol used to transport these are HTTP, although there are two main, distinct ways that these request can be sent, known as bindings

			<h3>POST binding</h3>
			The post binding is when communication between IDP and SP is done through an HTTP post request. This request is expected to be performed via HTTP form control,
			and has two important fields. 
			SAMLResponse: the actual SAML Response, base64 encoded
			RelayState: this really only has one main purpose in the IDP initiated SSO. The IDP can send along a URL of the service provider, and after the service provider parses and 
			accepts the SAML Resposne, the user gets redirected to that URL. This is not specifically stated in the SAML specification, but is often utilized

			This is most commonly used for SAML Responses, rather than requests
			<h3>REDIRECT binding</h3>
			The Redirect binding is the most commonly used format for SAML Requests. In this binding, the entity sending the SAML (either request or response). They are transmitted via the 
			HTTP GET method. Most commonly, the deflate compression algorithm is used, and then the resulting encoded binary is encoded via base64, and then urlencoded to make it url safe and sendable. Additionally if a RelayState must be included in the request or response, it must be url encoded and placed as a query parameter as well. In SP initiated SSO, if a relay state 
			is sent to the IDP, then the IDP must echo back the relay state exactly as is to the service provider.

			<h2>IAmShowcase website</h2>
			For all the code examples, the code will be acting as the identity provider in the flow. As such, we need a service provider in the loop. A great website for this is <a href="https://sptest.iamshowcase.com">IAmShowcase</a> which acts as a mock service provider and supports both idp initiated and service provider initiated SSO. 

			<h2>Metadata</h2>
			<p>
			Before we jump into the samlify code, its first important to describe IDP and SP metadata. These are also in the format of XML, and describe the specifics of what both the IDP 
			and SP expect during the SSO flow. 
			</p>
			<h3>Downloading SP metadata</h3>
				<p>
				For all service providers, metadata should be downloadable. Since we are working with IAMShowcase, a demo site specifically made to test SAML integration, the download
				is pretty straight forward

				<div class="image-description-block">
					<img src="./download-sp-meta.png" style="width:100%">
					<p>
					IAmShowcase metadata download
					</p>
				</div>

				The IAmShowcase metadata looks like so

			<pre class="prettyprint lang-xml" id="xml-block">
&lt;md:EntityDescriptor xmlns:md=&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot; xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot; entityID=&quot;IAMShowcase&quot; validUntil=&quot;2025-12-09T09:13:31.006Z&quot;&gt;
	&lt;md:SPSSODescriptor AuthnRequestsSigned=&quot;false&quot; WantAssertionsSigned=&quot;true&quot; protocolSupportEnumeration=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;&gt;
		&lt;md:NameIDFormat&gt;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&lt;/md:NameIDFormat&gt;
		&lt;md:NameIDFormat&gt;urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress&lt;/md:NameIDFormat&gt;
		&lt;md:AssertionConsumerService Binding=&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot; Location=&quot;https://sptest.iamshowcase.com/acs&quot; index=&quot;0&quot; isDefault=&quot;true&quot;/&gt;
	&lt;/md:SPSSODescriptor&gt;
&lt;/md:EntityDescriptor&gt; </pre>

			This XML provides the IDP with important information in regards to what the SP expects in the given SAML Response, things such as whether the assertion should be signed, 
			the supported nameID formats, the assertion consumer service URL (location to send SAML response to), and potentially much more. 
			Even potentially providing a public key to encrypt the contents of the SAML assertion
				</p>

			<h3>Creating IDP metadata</h3>
			<p>
			Because we are our own IDP here, we need to generate some IDP metadata. The IDP metadata does not need to be uploaded to the service provider, although typically the saml 
			assertion sent by the IDP is signed. The public certificate used is often embedded in the SAML Response, but it is still required to upload the public key to the service provider
			so that they can verify the authenticity of the SAML Response. In this case, IAmShowcase doesn't validate the signature on the SAMLResponse, so we do not need to upload anything.

			<br>

			In order to generate IDP metadata, first a keypair is required for the aforementioned signing portion. In order to generate this, I've created a simple bash script with openssl.


			<pre class="prettyprint lang-bsh">
#!/bin/bash

KEY=$(openssl genrsa 2048 2&gt/dev/null)
echo "$KEY"
echo "$KEY" | openssl req -new -key /dev/stdin -subj "/C=US/ST=CA/L=SF/O=Org/CN=localhost" 2&gt/dev/null | \
openssl x509 -req -days 365 -signkey <(echo "$KEY") 2>/dev/null</pre>

			This code utilizes the openssl command line tool, and prints out a public x509 cert, and the corresponding private key
			</p>

			<br>

			to actually create the IDP metadata, a website such as https://www.samltool.com/idp_metadata.php can be used. Simply entering information into the required 
			fields, along with the x509 public certificate generated in the last step will produce a file like so

			<pre class="prettyprint lang-xml" id="xml-block">
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;md:EntityDescriptor xmlns:md=&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot; validUntil=&quot;2025-11-24T19:31:58Z&quot; cacheDuration=&quot;PT1764444718S&quot; entityID=&quot;http://localhost:3000&quot;&gt;
  &lt;md:IDPSSODescriptor WantAuthnRequestsSigned=&quot;false&quot; protocolSupportEnumeration=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;&gt;
    &lt;md:KeyDescriptor use=&quot;signing&quot;&gt;
      &lt;ds:KeyInfo xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;MIIDQTCCAimgAwIBAgIUfKGITEBcwtKMKHPSumomAbLfS/kwDQYJKoZIhvcNAQELBQAwSTELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJTRjEMMAoGA1UECgwDT3JnMRIwEAYDVQQDDAlsb2NhbGhvc3QwHhcNMjUxMTIyMTkzMTI2WhcNMjYxMTIyMTkzMTI2WjBJMQswCQYDVQQGEwJVUzELMAkGA1UECAwCQ0ExCzAJBgNVBAcMAlNGMQwwCgYDVQQKDANPcmcxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJT02NwZbGyhS8iXxtTeEiwnCaffwHL6e5M8opMRiqDsM6roFeGb96bcBVAmuTv5GpVkcBN1jN/o8nkcqfMXq678H3aT2N+LqbHsWFhU969j0j/57Im267H6Z7+eRPcEnAL8ETTT6TEUY/XFYsb41kjrH9XXL0s8pLdzR0XTFLLEXc0qHU0uFVns5JftJS7o+nQ8uOO1QrJ8Xeh10qDio00D8rqMF3DTYrLJo4UkEYoz3oa04MLWOgiNbEqsW5X11JaJnJqeQD078jruT71IO2gAOd7KkOpuZP9Swse00EXTHTx7WMYodw7l6emjU1GOJXuSbHkA1ZCEAMLjje9TFEUCAwEAAaMhMB8wHQYDVR0OBBYEFFV7jw3PtIjLQZjsu7YRXPIGmsYcMA0GCSqGSIb3DQEBCwUAA4IBAQAQZg84siAYgG4blFBmyDx+Ksy1tpemxDfGRDo3zN3mvJDsQVZU5OQIpMzp8tKoVGK+1MOEi+3sO9gnXA7moDwfqsyE2GQOurLbMhO6XJluytX0La783PJrOMf6nL6oV4vEnjqIYDa31XvYy40/XY27PRkb9HWfm3QmbxwCy1XBdu6vhAWrCON+gCWh/DUjAa21MwOwNsL1H4FAdnSS8f49E6sH15WNi2lMr8uMU9wo6vkbY5REUOE2JX/xGKrQiEHBxEuiXoiyWaS8fFuO2vJlcXjs1TxBT1ZV/dCr8TC0zKv9i4GggWijtIXEb4VcsVO9IXGF3POWo/HVex7tSQQ3&lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
    &lt;/md:KeyDescriptor&gt;
    &lt;md:KeyDescriptor use=&quot;encryption&quot;&gt;
      &lt;ds:KeyInfo xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;
        &lt;ds:X509Data&gt;
          &lt;ds:X509Certificate&gt;MIIDQTCCAimgAwIBAgIUfKGITEBcwtKMKHPSumomAbLfS/kwDQYJKoZIhvcNAQELBQAwSTELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJTRjEMMAoGA1UECgwDT3JnMRIwEAYDVQQDDAlsb2NhbGhvc3QwHhcNMjUxMTIyMTkzMTI2WhcNMjYxMTIyMTkzMTI2WjBJMQswCQYDVQQGEwJVUzELMAkGA1UECAwCQ0ExCzAJBgNVBAcMAlNGMQwwCgYDVQQKDANPcmcxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJT02NwZbGyhS8iXxtTeEiwnCaffwHL6e5M8opMRiqDsM6roFeGb96bcBVAmuTv5GpVkcBN1jN/o8nkcqfMXq678H3aT2N+LqbHsWFhU969j0j/57Im267H6Z7+eRPcEnAL8ETTT6TEUY/XFYsb41kjrH9XXL0s8pLdzR0XTFLLEXc0qHU0uFVns5JftJS7o+nQ8uOO1QrJ8Xeh10qDio00D8rqMF3DTYrLJo4UkEYoz3oa04MLWOgiNbEqsW5X11JaJnJqeQD078jruT71IO2gAOd7KkOpuZP9Swse00EXTHTx7WMYodw7l6emjU1GOJXuSbHkA1ZCEAMLjje9TFEUCAwEAAaMhMB8wHQYDVR0OBBYEFFV7jw3PtIjLQZjsu7YRXPIGmsYcMA0GCSqGSIb3DQEBCwUAA4IBAQAQZg84siAYgG4blFBmyDx+Ksy1tpemxDfGRDo3zN3mvJDsQVZU5OQIpMzp8tKoVGK+1MOEi+3sO9gnXA7moDwfqsyE2GQOurLbMhO6XJluytX0La783PJrOMf6nL6oV4vEnjqIYDa31XvYy40/XY27PRkb9HWfm3QmbxwCy1XBdu6vhAWrCON+gCWh/DUjAa21MwOwNsL1H4FAdnSS8f49E6sH15WNi2lMr8uMU9wo6vkbY5REUOE2JX/xGKrQiEHBxEuiXoiyWaS8fFuO2vJlcXjs1TxBT1ZV/dCr8TC0zKv9i4GggWijtIXEb4VcsVO9IXGF3POWo/HVex7tSQQ3&lt;/ds:X509Certificate&gt;
        &lt;/ds:X509Data&gt;
      &lt;/ds:KeyInfo&gt;
    &lt;/md:KeyDescriptor&gt;
	&lt;md:SingleLogoutService Binding=&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot; Location=&quot;http://localhost:3000/saml/auth/logout&quot;/&gt;
    &lt;md:NameIDFormat&gt;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&lt;/md:NameIDFormat&gt;
	&lt;md:SingleSignOnService Binding=&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot; Location=&quot;http://localhost:3000/saml/auth&quot;/&gt;
  &lt;/md:IDPSSODescriptor&gt;
&lt;/md:EntityDescriptor&gt;
			</pre>

			As you can see here, mostly all the information from the website is embeded here. Information on where to send login requests for SP initiated SSO, the entityID,
			the public certificate for the signature value on the SAML Response, and a public key that can be used by service providers to encrypt the SAML Request, if applicable.

			<h3>Implementation</h3>
				<h4>samlify</h4>
				<p>
				Samlify is a NodeJS library that can be used to implement the SAML SSO flows. It allows for creation, parsing, and much more of both SAML requests and responses.
				The first thing that should be done when working with samlify is downloading the IDP and SP metadata, and creating the respective objects. We already took a look
				at the metadata for ourselves (IDP) and for the SP (IAmShowcase), so we can jump right into some examples. To demonstrate the various examples, I've create a super basic
				web server, that has three functionalities. One is a basic IDP initiated flow with no special SAML Response template, another is an IDP initated SSO with a custom SAML Response template, and the final one is a service provider initated SSO.
				</p>


				<h4>idp initiated sso default code example</h4>

				<p>
				The first example that I want to show is the most basic. Implementing an IDP initiated SSO with no custom SAML Response template. To demonstrate how to create the SAML Response itself, 
				</p>

				<pre class='prettyprint lang-typescript'>
export const generateDefaultSAMLResponse = async (entityId: string) =&gt {
	const idp = IdentityProvider({
		metadata: readFileSync(`${__dirname}/idp/metadata.xml`),
		privateKey: readFileSync(`${__dirname}/idp/private-key.pem`)
	})

	const sp = ServiceProvider({
		metadata: readFileSync(`${__dirname}/sp/${entityId}/metadata.xml`),
	})

	const request = {
		extract: {
			request: {
				id: undefined
			}
		}
	}

	const { context, entityEndpoint } = await idp.createLoginResponse(sp, request, Constants.wording.binding.post, {email: 'jack.a.gitter@gmail.com'})

	return { context, entityEndpoint, relayState: 'light-blue' }

}
				</pre>
				Here you can see that  we are able to create objects that represent both the sp and the idp, just by loading the meatdata files for each. We also need to provide a private key to sign the SAML assertion with, genearted via the bash script shown earlier. 
				The idp.createLoginResponse method is the method responsible for generating the SAML Response. It requires the service provider, a SAML Request object (mock object created, bare minimum), the binding to use, and a user object. With the user object, it is able to set things such as the nameId, and attributes in the SAML Response. Finally from this method, we return the context which is the SAML Response, the entityEndpoint which is the ACS URL, and the relay state. For IAMShowcase, setting the relay state changes the color of the UI of the website. This method is used in a simple HTTP get request after hitting the "sso" button on the frontend



            <div class="image-description-block">
				<img src="./home.png"/>
                <p>
				Extremely polished home screen
                </p>
            </div>

				<pre class='prettyprint lang-typescript'>
app.get('/sso/iamshowcase/login', async (_req: Request, res: Response) =&gt {
	const resp = await generateDefaultSAMLResponse(ENTITY_ID.I_AM_SHOWCASE)
	res.send(resp)
})
				</pre>

				The frontend then parses the information, creates a form, and POSTS the information to the service provider


				<pre class='prettyprint lang-typescript'>

const response = await fetch('http://localhost:3000/sso/iamshowcase/login');
const data = await response.json();

const samlResponse = data.context;
const acsUrl = data.entityEndpoint;
const relayState = data.relayState

const form = document.getElementById('samlForm');
form.action = acsUrl;
document.getElementById('samlResponse').value = samlResponse;
document.getElementById('relayState').value = relayState;

form.submit();
				</pre>


				And upon reaching the service provider, we are greeted with our information. Beacuse this SAML Response only contained the bare minimum information, we are limited to what information is shown 

            <div class="image-description-block">
				<img src="./sp-home.png"/>
                <p>
				service provider hoem screen after login via IDP
                </p>
            </div>


				<h4>idp initiated sso custom format code example</h4>
					<p>
					Most SPs are going to request some more information about the user, 
					or some specific fields such as an AuthnInformation field that is 
					not put in by samlify. In this case, samlify allows for using a custom XML format to create SAML Responses. This is going to be the example template that I use to craft a SAML response from


			<pre class="prettyprint lang-xml" id="xml-block">
&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; ID=&quot;{ID}&quot; Version=&quot;2.0&quot; IssueInstant=&quot;{IssueInstant}&quot; Destination=&quot;{Destination}&quot; InResponseTo=&quot;&quot;&gt;
	&lt;saml:Issuer&gt;{Issuer}&lt;/saml:Issuer&gt;
  &lt;samlp:Status&gt;
    &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;/&gt;
  &lt;/samlp:Status&gt;
  &lt;saml:Assertion xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; ID=&quot;{AssertionID}&quot; Version=&quot;2.0&quot; IssueInstant=&quot;{IssueInstant}&quot;&gt;
	  &lt;saml:Issuer&gt;{Issuer}&lt;/saml:Issuer&gt;
    &lt;saml:Subject&gt;
		&lt;saml:NameID Format=&quot;{NameIDFormat}&quot;&gt;{NameID}&lt;/saml:NameID&gt;
      &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;
		  &lt;saml:SubjectConfirmationData NotOnOrAfter=&quot;2024-01-18T06:21:48Z&quot; Recipient=&quot;{Recipient}&quot; InResponseTo=&quot;&quot;/&gt;
      &lt;/saml:SubjectConfirmation&gt;
    &lt;/saml:Subject&gt;
	&lt;saml:Conditions NotBefore=&quot;{NotBefore}&quot; NotOnOrAfter=&quot;{NotOnOrAfter}&quot;&gt;
      &lt;saml:AudienceRestriction&gt;
        &lt;saml:Audience&gt;{AudienceURI}&lt;/saml:Audience&gt;
      &lt;/saml:AudienceRestriction&gt;
    &lt;/saml:Conditions&gt;
	&lt;saml:AuthnStatement AuthnInstant=&quot;{AuthnInstant}&quot; SessionNotOnOrAfter=&quot;{NotOnOrAfter}&quot; SessionIndex=&quot;{SessionIndex}&quot;&gt;
      &lt;saml:AuthnContext&gt;
        &lt;saml:AuthnContextClassRef&gt;urn:oasis:names:tc:SAML:2.0:ac:classes:Password&lt;/saml:AuthnContextClassRef&gt;
      &lt;/saml:AuthnContext&gt;
    &lt;/saml:AuthnStatement&gt;
	&lt;saml:AttributeStatement&gt;
      &lt;saml:Attribute Name=&quot;Name&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;
		  &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;{Name}&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
      &lt;saml:Attribute Name=&quot;Email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;
		  &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;{Email}&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
    &lt;/saml:AttributeStatement&gt;
  &lt;/saml:Assertion&gt;
&lt;/samlp:Response&gt;
			</pre>
					You can see that we have variables in {} which are going to be replaced with information that is either taken from the IDP and SP metadata, the incoming http request (in the event of sp initiated sso), or from user information after login. Additionally to this we have notably added both attributes, and an authn statement, audience restriction, which most service providers will require some form of. In order to utilize this template with samlify, the code looks like this

				<pre class='prettyprint lang-typescript'>
	const template = readFileSync(`${__dirname}/idp/templates/response.xml`).toString()
	const idp = IdentityProvider({
		metadata: readFileSync(`${__dirname}/idp/metadata.xml`),
		privateKey: readFileSync(`${__dirname}/idp/private-key.pem`),
		loginResponseTemplate: {
			context: template,
			attributes: []
		}
	})

	const sp = ServiceProvider({
		metadata: readFileSync(`${__dirname}/sp/${entityId}/metadata.xml`),
		wantMessageSigned: true
	})

	const request = {
		extract: {
			request: {
				id: undefined
			}
		}
	}

	const user = {
		email: 'jack.gitter@gmail.com',
		name: 'jack',
	}

	const { context, entityEndpoint } = await idp.createLoginResponse(sp, request, Constants.wording.binding.post, user, (template: string) =&gt {
		return createTemplateCallback(idp, sp, user, template)
	})

	return { context, entityEndpoint, relayState: 'light-blue' }
}


const createTemplateCallback = (idp: any, sp: any, user: any, template: string) =&gt {
    const acsUrl = sp.entityMeta.getAssertionConsumerService(Constants.wording.binding.post)

    const nameIDFormat = idp.entitySetting.nameIDFormat
    const selectedNameIDFormat = Array.isArray(nameIDFormat) ? nameIDFormat[0] : nameIDFormat

    const id = `_${randomUUID()}`
    const now = new Date()
    const fiveMinutesLater = addMinutes(now, 5)

    const assertionId = `_${randomUUID()}`
	const sessionIndex = randomUUID()

    const tagValues = {
		ID: id,
		IssueInstant: now.toISOString(),
		Destination: acsUrl,
		Issuer: idp.entityMeta.getEntityID(),
		AssertionID: assertionId,
		NameIDFormat: selectedNameIDFormat,
		NameID: user.email,
		Recipient: acsUrl,
		NotBefore: now.toISOString(),
		NotOnOrAfter: fiveMinutesLater.toISOString(),
		AuthnInstant: now.toISOString(),
		SessionIndex: sessionIndex,
		Name: user.name,
		Email: user.email,
		AudienceURI: acsUrl
    }

    return {
        id,
        context: SamlLib.replaceTagsByValue(template, tagValues)
    }
}
					</pre>

					The code is almost the same, although with a couple of tweaks. We supply the IDP with our custom template, and this time set the wantMessageSigned service provider field to be true, meaning the idp will sign both the message and the assertion. Not required, just for demo purposes. We once again make a bare minimum SP request, setting the id to undefined. this time, we create a mock user, something that would be looked up from a database after a user signs in. We supply all of the same paremters, although this time a function that takes in our template. We then are able to utilize our callback function in order to replace the {} variables with information coming from the metadata, user object, and other sources.

					<br>

					After logging in this time, this time we are able to see more information on the service provider

					

					
            <div class="image-description-block">
				<img src="./authn.png"/>
                <p>
				Authn Information that was included in the SAML Response
                </p>
            </div>
            <div class="image-description-block">
				<img src="./attributes.png"/>
                <p>
				User attributes that were included in the custom SAML Response
                </p>
            </div>
            <div class="image-description-block">
				<img src="./details.png"/>
                <p>
				Other details, not audience tag
                </p>
            </div>
				<h4>sp initiated sso code example</h4>
					<p>explain URL that is generated by iamshowcase</p>
					<p>show authn request</p>
					<p>picture of my login page</p>
					<p>explain cookies, storing state</p>
					<p>picture of the login page after sso works</p>
        </article>
    </main>
    <footer>
        <span class="date">SWE @ Sentinel Group</span>
    </footer>
</body>
</html>
